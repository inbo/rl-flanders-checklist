---
title: "Darwin Core mapping Validated Red List Flanders"
subtitle: "For: Publication Red Lists Flanders, Belgium"
author:
- Dimitri Brosens
- Lien Reyserhove
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document describes how we map the red list data to Darwin Core. 

# Setup

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
library(tidyverse)  # tidyverse
library(magrittr)   # For %<>% pipes
library(janitor)    # For cleaning input data
library(knitr)      # For nicer (kable) tables
library(stringr)    # To perform string operations
library(digest)     # To generate hashes
library(rgbif)      # To Match GBIF
library(assertable) # because it sneeded for rGBIF
library(inborutils) # wrap GBIF api data
library(readr)
library(dplyr)
library(assertthat)


```

Set file paths (all paths should be relative to this script):

```{r}
# Raw files:

raw_data_file <- "../data/raw/validated/ValidatedRedListsSource.csv"


# Processed files:

dwc_taxon_file <- "../data/processed/validated/taxon.csv"
dwc_distribution_file = "../data/processed/validated/distribution.csv"
```

# Read and pre-process raw data

Create a data frame `raw_data` from the source data:

```{r}
raw_data <- read_delim(raw_data_file, ";", escape_double = FALSE, trim_ws = TRUE)
```

Clean the data somewhat: remove empty rows if present:

```{r}
raw_data %<>%
  remove_empty("rows") %>%    # Remove empty rows
  clean_names()               # Have sensible (lowercase) column names
```

## Further pre-processing:

Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
```
 
Preview data:

```{r}
head(raw_data)
```

# Create taxon core

```{r start_taxon}
taxon <- raw_data
```

## Term mapping

Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).

### language

```{r}
taxon %<>% mutate(language = "en")
```

### license

```{r}
taxon %<>% mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/")
```

### rightsHolder

```{r}
taxon %<>% mutate(rightsHolder = "INBO")
```

### datasetID

```{r}
taxon  %<>% mutate(datasetID = "to_be_completed")
```

### datasetName

```{r}
taxon %<>% mutate(datasetName = "Validated Red Lists Flanders, Belgium")
```

### treadStatus

All information required for `treadStatus` is included in `raw_rlc_as_published`

```{r}
taxon %>% distinct(raw_rlc_as_published)
```


```{r}
taxon %<>% mutate(threadStatus = recode()) 
```



```{r}
taxon %<>% mutate(threadStatus = str_replace(raw_rlc_as_published,"Bedreigd","Endangered (EN)" ) 

         , threadStatus = str_replace(threadStatus,"Bedreigd","Endangered (EN)" )
         , threadStatus = str_replace(threadStatus, "Kwetsbaar", "Vulnerable (VU)")
         , threadStatus = str_replace(threadStatus, "Ernstig bedreigd","Critically Endangered (CR)")
         , threadStatus = str_replace(threadStatus, "Momenteel niet bedreigd","Least Concern (LC)")
         , threadStatus = str_replace(threadStatus,"Momenteel niet in gevaar","Least Concern (LC)" )
         , threadStatus = str_replace(threadStatus," Met uitsterven bedreigd","Critically Endangered (CR)" )
         , threadStatus = str_replace(threadStatus,"Bijna in gevaar","Near Threatened (NT)" )
         , threadStatus = str_replace(threadStatus,"Met uitsterven bedreigd","Critically Endangered (CR)" )
         , threadStatus = str_replace(threadStatus,"Zeldzaam","Near Threatened (NT)" )
         , threadStatus = str_replace(threadStatus, "Uitgestorven","Regionally Extinct (REX)")
         , threadStatus = str_replace(threadStatus, "Achteruitgaand","Near Threatened (NT)")
         , threadStatus = str_replace(threadStatus,"Onvoldoende gekend","Data Deficient (DD)" )
         , threadStatus = str_replace(threadStatus, "Onvoldoende data ", "Data Deficient (DD)"	)
         , threadStatus = str_replace(threadStatus, "Regionaal uitgestorven","Regionally Extinct (EX)")
         , threadStatus = str_replace(threadStatus, "maar mate waarin ongekend","uncertain rate")
         , threadStatus = str_replace(threadStatus, "in Vlaanderen","in Flanders")) %>%


 mutate(threadStatus = recode (threadStatus
      , "Geografisch beperkt" = "Geographically Limited (NT)"
      , "Endangered (EN), maar niet gekend in welke mate" = "Endangered (EN), but not known to what extent"
      , "Near Threatened (NT) (vrij zeldzaam)"="Near Threatened (NT) (quite rare)"
      , "Near Threatened (NT) (zeer zeldzaam)"="Near Threatened (NT) (very rare)"
      , "Near Threatened (NT) (zeldzaam)"="Near Threatened (NT) (rare)"
      , "Niet bedreigd" = "Least Concern (LC)"
      , "Least concern"="Least Concern (LC)"
      , "Sterk bedreigd"="Critically Endangered (EN)"
      , "Vulnerable" = "Vulnerable (VU)"
      , "Verdwenen"= "Disappeared (RE)"
      , "Waarschijnlijk bedreigd"="Probably Endangered (NT)"
      , "Vermoedelijk bedreigd"="Presumably Threatened (DD/PT)"
      , "Vatbaar voor bedreiging"="Vulnerable to threat (NT)"
      , "Critically endangered"="Critically Endangered (CR)"
      , "Critically Endangered"="Critically Endangered (CR)"
      , "Endangered"= "Endangered (EN)"
      , "Regionally extinct"="Regionally extinct (RE)"
      , "Disappeared"="Disapeared (RE)"
      , "Near threatened"="Near Threatened (NT)"
      , "Probably Endangered"="Probably Endangered (DD/PT)"
      , "Geographically Limited"="Geographically Limited (NT)")) 
  
```

### scientificName

```{r}
taxon %<>% rename(scientificName = raw_speciesname_as_published)
```



###occurrenceStatus

```{r}
taxon %<>% mutate(occurrenceStatus = "present")
```

###taxonID
```{r}
taxon %<>% rename(taxonID = raw_unique_id)
```

###taxonRank
taxon %<>% mutate(taxonRank = "species")




Preview data:

```{r}
head(raw_data)
head(taxon)
```

### vernacularName
```{r}
taxon %<>% rename(vernacularName = raw_speciesname_dutch) 
```

### nomenclaturalCode

taxon %<>% mutate(nomenclaturalCode =case_when(raw_kingdom == "Animalia" ~ "ICZN",raw_kingdom == "Plantae" ~ "ICBN"  )) 


### kingdom

```{r}
taxon %<>% rename(kingdom = raw_kingdom)
```

### references

```{r}
taxon %<>% rename(references = raw_reference)
```
 
## Post-processing

Remove the original columns:

```{r}
taxon %<>% select(-starts_with("raw_"))
```

Sort on `taxonID`:

```{r}
taxon %<>% arrange(taxonID)
```

```{r}
View(taxon)
taxontest <- head(taxon, n = 100)
View(taxontest)
```


###Request Species Information
```{r warning=FALSE}
taxon%<>%
   gbif_species_name_match(name_col = "scientificName", 
                           gbif_terms= c('usageKey', 'scientificName', 'rank', 
                                         'order','matchType', 'phylum', 'kingdom',
                                         'genus','class','confidence',  'synonym',
                                         'status','family')) 


```

Preview data:

```{r}
head(dwc_taxon_file)
```

Save to CSV:

```{r}
write.csv(taxon, file = dwc_taxon_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

# Create distribution extension

```{r start_distribution}
distribution <- raw_data
```

## Term mapping

Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

###taxonID
```{r}
distribution %<>% rename(taxonID = raw_unique_id)
```

### locality

```{r}
distribution %<>% mutate(locality = "Flanders")
```


###countryCode

```{r}
distribution %<>% mutate(countryCode = "BE")
```


###locationID

```{r}
distribution%<>% mutate(locationID = "ISO_3166-2:BE-VLG")
  
```

### treadStatus
```{r}
distribution %<>%  mutate(threadStatus = str_replace(raw_rlc_as_published,"Bedreigd","Endangered (EN)" ) 

         , threadStatus = str_replace(threadStatus,"Bedreigd","Endangered (EN)" )
         , threadStatus = str_replace(threadStatus, "Kwetsbaar", "Vulnerable (VU)")
         , threadStatus = str_replace(threadStatus, "Ernstig bedreigd","Critically Endangered (CR)")
         , threadStatus = str_replace(threadStatus, "Momenteel niet bedreigd","Least Concern (LC)")
         , threadStatus = str_replace(threadStatus,"Momenteel niet in gevaar","Least Concern (LC)" )
         , threadStatus = str_replace(threadStatus," Met uitsterven bedreigd","Critically Endangered (CR)" )
         , threadStatus = str_replace(threadStatus,"Bijna in gevaar","Near Threatened (NT)" )
         , threadStatus = str_replace(threadStatus,"Met uitsterven bedreigd","Critically Endangered (CR)" )
         , threadStatus = str_replace(threadStatus,"Zeldzaam","Near Threatened (NT)" )
         , threadStatus = str_replace(threadStatus, "Uitgestorven","Regionally Extinct (REX)")
         , threadStatus = str_replace(threadStatus, "Achteruitgaand","Near Threatened (NT)")
         , threadStatus = str_replace(threadStatus,"Onvoldoende gekend","Data Deficient (DD)" )
         , threadStatus = str_replace(threadStatus, "Onvoldoende data ", "Data Deficient (DD)"	)
         , threadStatus = str_replace(threadStatus, "Regionaal uitgestorven","Regionally Extinct (EX)")
         , threadStatus = str_replace(threadStatus, "maar mate waarin ongekend","uncertain rate")
         , threadStatus = str_replace(threadStatus, "in Vlaanderen","in Flanders")) %>%


 mutate(threadStatus = recode (threadStatus
      , "Geografisch beperkt" = "Geographically Limited (NT)"
      , "Endangered (EN), maar niet gekend in welke mate" = "Endangered (EN), but not known to what extent"
      , "Near Threatened (NT) (vrij zeldzaam)"="Near Threatened (NT) (quite rare)"
      , "Near Threatened (NT) (zeer zeldzaam)"="Near Threatened (NT) (very rare)"
      , "Near Threatened (NT) (zeldzaam)"="Near Threatened (NT) (rare)"
      , "Niet bedreigd" = "Least Concern (LC)"
      , "Least concern"="Least Concern (LC)"
      , "Sterk bedreigd"="Critically Endangered (EN)"
      , "Vulnerable" = "Vulnerable (VU)"
      , "Verdwenen"= "Disappeared (RE)"
      , "Waarschijnlijk bedreigd"="Probably Endangered (NT)"
      , "Vermoedelijk bedreigd"="Presumably Threatened (DD/PT)"
      , "Vatbaar voor bedreiging"="Vulnerable to threat (NT)"
      , "Critically endangered"="Critically Endangered (CR)"
      , "Critically Endangered"="Critically Endangered (CR)"
      , "Endangered"= "Endangered (EN)"
      , "Regionally extinct"="Regionally extinct (RE)"
      , "Disappeared"="Disapeared (RE)"
      , "Near threatened"="Near Threatened (NT)"
      , "Probably Endangered"="Probably Endangered (DD/PT)"
      , "Geographically Limited"="Geographically Limited (NT)")) 
  
```

### establishmentMeans

### eventDate


```{r}
distribution %<>% rename(eventDate = raw_year_published)
```


### source

```{r}
distribution %<>% rename(source = raw_reference)
```

### Non DwC_terms

```{r}
distribution %<>% rename(biome = raw_biome) %>%
                  rename(biotope1 = raw_biotope1) %>%
                  rename(iucn_criteria = raw_iucn_criteria) %>%
                  rename(redListCriteria = raw_rlc) %>%
                  rename(criteria = raw_criteria) %>%
                  rename(redListCriteriaEurope = raw_rlc_europe) %>%
                  rename(lifespan = raw_lifespan) %>%
                  rename(cuddliness = raw_cuddliness) %>%
                  rename(mobility = raw_mobility) %>%
                  rename(spine = raw_spine) %>%
                  rename(nutrient_level= raw_nutrient_level)


```

## Post-processing

Remove the original columns:

```{r}
distribution %<>% select(-starts_with("raw_"))
```

Sort on `taxonID`:

```{r}
distribution %<>% arrange(taxonID)
```

Preview data:

```{r}
distribution %>%
  mutate(source = substr(source, 1, 10)) %>% # Shorten source to make it easier to display
  head()
```

Save to CSV:

```{r}
write.csv(distribution, file = dwc_distribution_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

