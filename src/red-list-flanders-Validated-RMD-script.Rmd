---
title: "Darwin Core mapping"
subtitle: "For:  Validated Red List Flanders, Belgium"
author:
- Lien Reyserhove
- Peter Desmet
- Dimitri Brosens
- Dirk Maes
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document describes how we map the red list data to Darwin Core. 

# Setup

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
library(tidyverse)  # tidyverse
library(magrittr)   # For %<>% pipes
library(janitor)    # For cleaning input data
library(knitr)      # For nicer (kable) tables
library(stringr)    # To perform string operations
library(digest)     # To generate hashes
library(rgbif)      # To Match GBIF
library(assertable) # because it sneeded for rGBIF
library(inborutils) # wrap GBIF api data
library(readr)
library(dplyr)
library(assertthat)
library(here)


```


# Read and pre-process raw data

Create a data frame `raw_data` from the source data:

# Read the source data:

```{r}
raw_data <- read_delim(here("data", "raw", "validated", "ValidatedRedListsSource.csv"), delim = ";")
```

Clean the data somewhat: remove empty rows if present:

```{r}
raw_data %<>%
  remove_empty("rows") %>%    # Remove empty rows
  clean_names()               # Have sensible (lowercase) column names
```



## Further pre-processing:

Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
```
 
Preview data:

```{r}
head(raw_data)

```

# Create taxon core

```{r start_taxon}
taxon <- raw_data
```

## Term mapping
Map the data to [Darwin Core Taxon](http://rs.gbif.org/core/dwc_taxon_2015-04-24.xml).

### language
```{r}
taxon %<>% mutate(language = "en")

```
### license
```{r}
taxon %<>% mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/")
```
### rightsHolder
```{r}
taxon %<>% mutate(rightsHolder = "INBO")
```

### datasetID
```{r}
taxon  %<>% mutate(datasetID = "https://doi.org/10.15468/8tk3tk")
```
### datasetName
```{r}
taxon %<>% mutate(datasetName = "Validated Red Lists Flanders Flanders, Belgium")
```

### scientificName
```{r}
taxon %<>% rename(scientificName = raw_speciesname_as_published)
```


###occurrenceStatus

```{r}
taxon %<>% mutate(occurrenceStatus = "present")
```

###taxonID
```{r}
taxon %<>% rename(taxonID = raw_unique_id)
```

###taxonRank
```{r}
taxon %<>% mutate(taxonRank = "species")
```



### vernacularName
```{r}
taxon %<>% rename(vernacularName = raw_speciesname_dutch) 

View(taxon)
```

### nomenclaturalCode

```{r}
taxon %<>% mutate(nomenclaturalCode =case_when(raw_kingdom == "Animalia" ~ "ICZN",raw_kingdom == "Plantae" ~ "ICBN"  )) 

```


### kingdom

```{r}
taxon %<>% rename(kingdom = raw_kingdom)
```

### references

```{r}
taxon %<>% rename(references = raw_reference)
```
 
## Post-processing

Remove the original columns:

```{r}
taxon %<>% select(-starts_with("raw_"))
```

Sort on `taxonID`:

```{r}
taxon %<>% arrange(taxonID)
```

```{r}
View(taxon)
taxontest <- head(taxon, n = 100)
View(taxontest)
```

###Request Species Information
```{r warning=FALSE}
taxon%<>%
   gbif_species_name_match(name_col = "scientificName", 
                           gbif_terms= c('usageKey', 'scientificName', 'rank', 
                                         'order','matchType', 'phylum', 'kingdom',
                                         'genus','class','confidence',  'synonym',
                                         'status','family')) 


```
### remove obsolete columns

```{r}
taxon %<>% select(-c(confidence, synonym, matchType, usageKey, rank)) 
            
```
#```{r}
#taxon %<>% select(-c(matchType, usageKey)) 
#taxon %<>% select(-c(rank)) 
#```


Save to CSV:

```{r}

write_csv(taxon, here("data", "processed", "validated", "taxon.csv"), na = "" )
```

# Create distribution extension

```{r start_distribution}
distribution <- raw_data
```

## Term mapping

Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml).

###taxonID
```{r}
distribution %<>% rename(taxonID = raw_unique_id)
```

### locality

```{r}
distribution %<>% mutate(locality = "Flanders")
```


###occurrenceStatus

```{r}
distribution %<>% mutate(occurrenceStatus = "present")
```

###countryCode

```{r}
distribution %<>% mutate(countryCode = "BE")
```


###locationID

```{r}
distribution%<>% mutate(locationID = "ISO_3166-2:BE-VLG")
  
```

### treatStatus
```{r}
distribution %<>%
 mutate(threatStatus = recode (raw_rlc_as_published
      , "Geografisch beperkt" = "Geographically Limited (NT)"
      , "Endangered (EN), maar niet gekend in welke mate" = "Endangered (EN), but not known to what extent"
      , "Near Threatened (NT) (vrij zeldzaam)"="Near Threatened (NT) (quite rare)"
      , "Near Threatened (NT) (zeer zeldzaam)"="Near Threatened (NT) (very rare)"
      , "Near Threatened (NT) (zeldzaam)"="Near Threatened (NT) (rare)"
      , "Niet bedreigd" = "Least Concern (LC)"
      , "Least concern"="Least Concern (LC)"
      , "Sterk bedreigd"="Critically Endangered (EN)"
      , "Vulnerable" = "Vulnerable (VU)"
      , "Verdwenen"= "Disappeared (RE)"
      , "Waarschijnlijk bedreigd"="Probably Endangered (NT)"
      , "Vermoedelijk bedreigd"="Presumably Threatened (DD/PT)"
      , "Vatbaar voor bedreiging"="Vulnerable to threat (NT)"
      , "Critically endangered"="Critically Endangered (CR)"
      , "Critically Endangered"="Critically Endangered (CR)"
      , "Endangered"= "Endangered (EN)"
      , "Regionally extinct"="Regionally extinct (RE)"
      , "Disappeared"="Disapeared (RE)"
      , "Near threatened"="Near Threatened (NT)"
      , "Probably Endangered"="Probably Endangered (DD/PT)"
      , "Geographically Limited"="Geographically Limited (NT)" 
      , "Bedreigd"="Endangered (EN)" 
      , "Kwetsbaar"= "Vulnerable (VU)"
      , "Ernstig bedreigd"="Critically Endangered (CR)"
      , "Momenteel niet bedreigd"="Least Concern (LC)"
      , "Momenteel niet in gevaar"="Least Concern (LC)"
      , "Met uitsterven bedreigd"="Critically Endangered (CR)"
      , "Bijna in gevaar"="Near Threatened (NT)"
      , "Met uitsterven bedreigd"="Critically Endangered (CR)"
      , "Zeldzaam"="Near Threatened (NT)"
      , "Uitgestorven"="Regionally Extinct (REX)"
      , "Achteruitgaand"="Near Threatened (NT)"
      , "Onvoldoende gekend"="Data Deficient (DD)"
      , "Onvoldoende data "= "Data Deficient (DD)"
      , "Regionaal uitgestorven"="Regionally Extinct (EX)"
      , "maar mate waarin ongekend"="uncertain rate"
      , "in Vlaanderen"="in Flanders")) 
  
```

### establishmentMeans
```{r}
distribution %<>% mutate(establishmentMeans = "native")
```

### occurrenceRemarks

```{r}
distribution %<>% rename(occurrenceRemarks = raw_iucn_criteria)
```


### eventDate


```{r}
distribution %<>% rename(eventDate = raw_year_published)
```


### source

```{r}
distribution %<>% rename(source = raw_reference)
```

### Non DwC_terms

```{r eval=FALSE} 
distribution %<>% rename(biome = raw_biome) %>%
                  rename(biotope1 = raw_biotope1) %>%
                  #rename(iucn_criteria = raw_iucn_criteria) %>%
                  rename(redListCriteria = raw_rlc_iucn) %>%
                  rename(criteria = raw_criteria) %>%
                  rename(redListCriteriaEurope = raw_rlc_europe) %>%
                  rename(lifespan = raw_lifespan) %>%
                  rename(cuddliness = raw_cuddliness) %>%
                  rename(mobility = raw_mobility) %>%
                  rename(spine = raw_spine) %>%
                  rename(nutrient_level= raw_nutrient_level)


```
 
## Post-processing

Remove the original columns:

```{r}
distribution %<>% select(-starts_with("raw_"))
```

Sort on `taxonID`:

```{r}
distribution %<>% arrange(taxonID)
```


Save to CSV:

```{r}
write_csv(distribution, here("data", "processed", "validated", "distribution.csv"), na = "" )
```




## Create Description Extension



```{r start_taxon}

description <- raw_data


```

```{r}
description %<>% select(raw_unique_id, raw_biome, raw_biotope1, raw_biotope2, raw_cuddliness, raw_lifespan, raw_mobility, raw_nutrient_level, raw_spine, raw_reference )

```

## Post-processing

```{r}
description %<>%  rename(biome = raw_biome) %>%
                  rename(biotope1 = raw_biotope1) %>%
                  rename(biotope2 = raw_biotope2) %>%
                 # rename(iucn_criteria = raw_iucn_criteria) %>%
                 # rename(redListCriteria = raw_rlc_iucn) %>%
                 # rename(criteria = raw_criteria) %>%
                 # rename(redListCriteriaEurope = raw_rlc_europe) %>%
                  rename(lifespan = raw_lifespan) %>%
                  rename(cuddliness = raw_cuddliness) %>%
                  rename(mobility = raw_mobility) %>%
                  rename(spine = raw_spine) %>%
                  rename(nutrient_level= raw_nutrient_level) %>%
                  rename(source = raw_reference)


```
 


## Columns into rows

```{r}
description <-  description %>% 
  gather(key = type_measure, value = value, -raw_unique_id, -source)
View(description)

```

###taxonID
```{r}
description %<>% rename(taxonID = raw_unique_id)
```

###type_measure
```{r}
description %<>% rename(type = type_measure)
```

###type_measure
```{r}
description %<>% rename(description = value)
```

## Post-processing



Sort on `taxonID`:

```{r}
description %<>% arrange(taxonID)
View(description)
```



Save to CSV:

```{r}
write_csv(description, here("data", "processed", "validated", "description.csv"), na = "" )
```

